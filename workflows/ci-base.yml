# QR Pipeline - Base CI Workflow (Updated for Self-Hosted Runners)
# Reusable workflow for all QuantumRishi repositories
# Usage: uses: QuantumRishi/qr-pipeline/.github/workflows/ci-base.yml@main

name: CI Base

on:
  workflow_call:
    inputs:
      node-version:
        description: 'Node.js version'
        required: false
        type: string
        default: '20'
      pnpm-version:
        description: 'pnpm version'
        required: false
        type: string
        default: '9'
      working-directory:
        description: 'Working directory'
        required: false
        type: string
        default: '.'
      run-tests:
        description: 'Run tests'
        required: false
        type: boolean
        default: true
      run-lint:
        description: 'Run linting'
        required: false
        type: boolean
        default: true
      run-typecheck:
        description: 'Run type checking'
        required: false
        type: boolean
        default: true
      use-self-hosted:
        description: 'Use self-hosted runners'
        required: false
        type: boolean
        default: false
    secrets:
      NPM_TOKEN:
        required: false

jobs:
  ci:
    name: CI
    runs-on: ${{ inputs.use-self-hosted && fromJSON('["self-hosted", "linux", "qr"]') || 'ubuntu-latest' }}
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}

    steps:
      - name: ğŸ” Harden Runner
        if: ${{ !inputs.use-self-hosted }}
        uses: step-security/harden-runner@17d0e2bd7d51742c71671bd19fa12bdc9d40a3d6 # v2.8.1
        with:
          egress-policy: audit

      - name: ğŸ“¥ Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0
        with:
          version: ${{ inputs.pnpm-version }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@60ecd5dd545e0ff3b4a7ad3a7dcd866e9a06ee06 # v4.0.2
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'pnpm'
          cache-dependency-path: ${{ inputs.working-directory }}/pnpm-lock.yaml

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: ğŸ” Lint
        if: ${{ inputs.run-lint }}
        run: pnpm lint

      - name: ğŸ“ Type check
        if: ${{ inputs.run-typecheck }}
        run: pnpm typecheck

      - name: ğŸ§ª Test
        if: ${{ inputs.run-tests }}
        run: pnpm test
